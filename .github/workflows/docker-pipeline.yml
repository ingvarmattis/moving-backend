name: Docker Pipeline

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

env:
  REGISTRY: us-east4-docker.pkg.dev
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REPOSITORY: containers

jobs:
  test:
    runs-on: ubuntu-latest
    environment: moving-backend
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_REGISTRY_SA_KEY }}

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

    - name: Build test image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./build/app/docker/Dockerfile
        platforms: linux/amd64
        push: false
        load: true
        tags: ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/backend:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILDKIT_INLINE_CACHE=1

    - name: Test Docker image
      run: |
        docker run -d --name test-container -p 8001:8001 \
          -e MOVING_SERVICE_GRPC_SERVER_LISTEN_PORT=8000 \
          -e MOVING_SERVICE_HTTP_SERVER_LISTEN_PORT=8001 \
          -e MOVING_SERVICE_POSTGRES_URL=postgres://test:test@localhost/test \
          -e MOVING_SERVICE_METRICS_ENABLED=false \
          -e MOVING_SERVICE_HTTP_METRICS_SERVER_LISTEN_PORT=9090 \
          -e MOVING_SERVICE_OPENTELEMETRY_ENABLED=false \
          -e MOVING_SERVICE_OPENTELEMETRY_COLLECTOR_URL=http://localhost:4317 \
          -e MOVING_SERVICE_OPENTELEMETRY_USE_TLS=false \
          ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/backend:test || true
        sleep 5
        docker ps | grep test-container || echo "Container test skipped (requires database)"
        docker stop test-container 2>/dev/null || true
        docker rm test-container 2>/dev/null || true

  build-push:
    runs-on: ubuntu-latest
    environment: moving-backend
    if: github.event_name != 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_REGISTRY_SA_KEY }}

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/backend
        tags: |
          type=raw,value=latest
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix=,suffix=,format=long

    - name: Build and Push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./build/app/docker/Dockerfile
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILDKIT_INLINE_CACHE=1

    - name: Output image info
      run: |
        echo "Image pushed successfully!"
        echo "Project ID: ${{ vars.GCP_PROJECT_ID }}"
        echo "Registry: ${{ env.REGISTRY }}"
        echo "Repository: ${{ env.REPOSITORY }}"
        echo "Tags: ${{ steps.meta.outputs.tags }}"
        echo "Labels: ${{ steps.meta.outputs.labels }}"
        echo "Full image path: ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/backend"

  migrate:
    needs: [build-push]
    runs-on: ubuntu-latest
    environment: moving-backend
    if: github.event_name != 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Copy migrations to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ vars.HOME_SERVER_IP }}
        username: ${{ vars.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2222
        source: "backend/build/app/migrations"
        target: "$HOME"

    - name: Run database migrations
      uses: appleboy/ssh-action@v1.0.3
      env:
        POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
      with:
        host: ${{ vars.HOME_SERVER_IP }}
        username: ${{ vars.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2222
        envs: POSTGRES_URL
        script: |
          if [ -z "$POSTGRES_URL" ]; then
            echo "âŒ Error: POSTGRES_URL must be set in secrets"
            exit 1
          fi
          
          echo "ðŸ“¦ Running database migrations..."
          docker run --rm \
            --network shared-network \
            -v "$HOME/build/app/migrations:/migrations" \
            migrate/migrate \
            -path /migrations \
            -database "$POSTGRES_URL" \
            up
          
          if [ $? -eq 0 ]; then
            echo "âœ… Migrations completed successfully!"
          else
            echo "âŒ Migration failed!"
            exit 1
          fi

  deploy:
    needs: [test, build-push, migrate]
    runs-on: ubuntu-latest
    environment: moving-backend
    if: github.event_name != 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Verify environment variables
      run: |
        if [ -z "${{ vars.HOME_SERVER_IP }}" ]; then
          echo "âŒ HOME_SERVER_IP variable is not set"
          exit 1
        fi
        
        if [ -z "${{ vars.SSH_USER }}" ]; then
          echo "âŒ SSH_USER variable is not set"
          exit 1
        fi
        
        if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
          echo "âŒ SSH_PRIVATE_KEY secret is not set"
          exit 1
        fi
        
        echo "âœ… All required variables and secrets are set"

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_REGISTRY_SA_KEY }}

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

    - name: Deploy to home server
      uses: appleboy/ssh-action@v1.0.3
      env:
        POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
      with:
        host: ${{ vars.HOME_SERVER_IP }}
        username: ${{ vars.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2222
        envs: POSTGRES_URL
        script: |
          # Clone or update repository
          REPO_DIR="$HOME/moving-backend"
          if [ -d "$REPO_DIR/.git" ]; then
            echo "ðŸ“¥ Updating existing repository..."
            cd "$REPO_DIR"
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master
          else
            echo "ðŸ“¥ Cloning repository..."
            mkdir -p "$REPO_DIR"
            git clone https://github.com/${{ github.repository }}.git "$REPO_DIR"
            cd "$REPO_DIR"
          fi
          
          cd "$REPO_DIR/backend" || { echo "âŒ backend directory not found"; exit 1; }
          
          # Check if POSTGRES_URL is set
          if [ -z "$POSTGRES_URL" ]; then
            echo "âŒ Error: POSTGRES_URL must be set in secrets"
            exit 1
          fi
          
          # Export POSTGRES_URL for deploy script
          export POSTGRES_URL="$POSTGRES_URL"
          
          # Set other optional environment variables
          export METRICS_ENABLED="${{ vars.METRICS_ENABLED || 'false' }}"
          export OPENTELEMETRY_ENABLED="${{ vars.OPENTELEMETRY_ENABLED || 'false' }}"
          export OPENTELEMETRY_COLLECTOR_URL="${{ vars.OPENTELEMETRY_COLLECTOR_URL || 'http://localhost:4317' }}"
          export OPENTELEMETRY_USE_TLS="${{ vars.OPENTELEMETRY_USE_TLS || 'false' }}"
          
          # Save GCP key for authentication
          echo '${{ secrets.GCP_REGISTRY_SA_KEY }}' > gcp-key.json
          chmod 600 gcp-key.json
          
          # Make deploy script executable
          chmod +x scripts/deploy-swarm.sh
          
          # Run deployment script
          ./scripts/deploy-swarm.sh
          
          # Clean up GCP key
          rm -f gcp-key.json
          
          echo "âœ… Deployment completed successfully!"

    - name: Health check
      run: |
        echo "Waiting for deployment to stabilize..."
        sleep 30
        
        if [ -n "${{ secrets.DYNDNS_URL }}" ]; then
          echo "Checking health via DynDNS: ${{ secrets.DYNDNS_URL }}"
          curl -f "http://${{ secrets.DYNDNS_URL }}:8001/health" || echo "Warning: Health check failed"
        fi

    - name: Deployment summary
      run: |
        echo "ðŸš€ Deployment completed!"
        echo "Image: ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/backend:latest"
        echo "Server: ${{ vars.HOME_SERVER_IP }}"
        echo "Port: 8001"
        if [ -n "${{ secrets.DYNDNS_URL }}" ]; then
          echo "Public URL: http://${{ secrets.DYNDNS_URL }}:8001"
        fi

