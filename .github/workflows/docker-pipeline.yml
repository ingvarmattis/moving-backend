name: Docker Pipeline

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

env:
  REGISTRY: us-east4-docker.pkg.dev
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REPOSITORY: containers

jobs:
  test:
    runs-on: ubuntu-latest
    environment: moving-backend
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_REGISTRY_SA_KEY }}

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

    - name: Build test image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./build/app/docker/Dockerfile
        platforms: linux/amd64
        push: false
        load: true
        tags: ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/backend:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILDKIT_INLINE_CACHE=1

    - name: Test Docker image
      run: |
        docker run -d --name test-container -p 8001:8001 \
          -e MOVING_SERVICE_GRPC_SERVER_LISTEN_PORT=8000 \
          -e MOVING_SERVICE_HTTP_SERVER_LISTEN_PORT=8001 \
          -e MOVING_SERVICE_POSTGRES_URL=postgres://test:test@localhost/test \
          -e MOVING_SERVICE_METRICS_ENABLED=false \
          -e MOVING_SERVICE_HTTP_METRICS_SERVER_LISTEN_PORT=9090 \
          -e MOVING_SERVICE_OPENTELEMETRY_ENABLED=false \
          -e MOVING_SERVICE_OPENTELEMETRY_COLLECTOR_URL=http://localhost:4317 \
          -e MOVING_SERVICE_OPENTELEMETRY_USE_TLS=false \
          ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/backend:test || true
        sleep 5
        docker ps | grep test-container || echo "Container test skipped (requires database)"
        docker stop test-container 2>/dev/null || true
        docker rm test-container 2>/dev/null || true

  build-push:
    runs-on: ubuntu-latest
    environment: moving-backend
    if: github.event_name != 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_REGISTRY_SA_KEY }}

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/backend
        tags: |
          type=raw,value=latest
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix=,suffix=,format=long

    - name: Build and Push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./build/app/docker/Dockerfile
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILDKIT_INLINE_CACHE=1

    - name: Output image info
      run: |
        echo "Image pushed successfully!"
        echo "Project ID: ${{ vars.GCP_PROJECT_ID }}"
        echo "Registry: ${{ env.REGISTRY }}"
        echo "Repository: ${{ env.REPOSITORY }}"
        echo "Tags: ${{ steps.meta.outputs.tags }}"
        echo "Labels: ${{ steps.meta.outputs.labels }}"
        echo "Full image path: ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/backend"

  deploy:
    needs: [test, build-push]
    runs-on: ubuntu-latest
    environment: moving-backend
    if: github.event_name != 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Verify environment variables
      run: |
        if [ -z "${{ vars.HOME_SERVER_IP }}" ]; then
          echo "‚ùå HOME_SERVER_IP variable is not set"
          exit 1
        fi
        
        if [ -z "${{ vars.SSH_USER }}" ]; then
          echo "‚ùå SSH_USER variable is not set"
          exit 1
        fi
        
        if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
          echo "‚ùå SSH_PRIVATE_KEY secret is not set"
          exit 1
        fi
        
        echo "‚úÖ All required variables and secrets are set"

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_REGISTRY_SA_KEY }}

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

    - name: Deploy to home server
      uses: appleboy/ssh-action@v1.0.3
      env:
        POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
      with:
        host: ${{ vars.HOME_SERVER_IP }}
        username: ${{ vars.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2222
        envs: POSTGRES_URL
        script: |
          set -e
          
          STACK_NAME="moving-backend"
          COMPOSE_FILE="/tmp/docker-swarm.yml"
          REGISTRY="us-east4-docker.pkg.dev"
          PROJECT_ID="honest-moving"
          REPOSITORY="containers"
          IMAGE_NAME="backend"
          
          echo "üöÄ Deploying moving-backend to Docker Swarm..."
          
          # Check if POSTGRES_URL is set
          if [ -z "$POSTGRES_URL" ]; then
            echo "‚ùå Error: POSTGRES_URL must be set in secrets"
            exit 1
          fi
          
          # Create docker-swarm.yml file
          cat > "$COMPOSE_FILE" << 'EOF'
          services:
            backend:
              image: us-east4-docker.pkg.dev/honest-moving/containers/backend:latest
              environment:
                - TZ=UTC
                - MOVING_SERVICE_GRPC_SERVER_LISTEN_PORT=8000
                - MOVING_SERVICE_HTTP_SERVER_LISTEN_PORT=8001
                - MOVING_SERVICE_POSTGRES_URL=${POSTGRES_URL}
                - MOVING_SERVICE_METRICS_ENABLED=${METRICS_ENABLED:-false}
                - MOVING_SERVICE_HTTP_METRICS_SERVER_LISTEN_PORT=9090
                - MOVING_SERVICE_OPENTELEMETRY_ENABLED=${OPENTELEMETRY_ENABLED:-false}
                - MOVING_SERVICE_OPENTELEMETRY_COLLECTOR_URL=${OPENTELEMETRY_COLLECTOR_URL:-http://localhost:4317}
                - MOVING_SERVICE_OPENTELEMETRY_USE_TLS=${OPENTELEMETRY_USE_TLS:-false}
              ports:
                - "8001:8001"
              networks:
                - shared-network
              logging:
                driver: "json-file"
                options:
                  max-size: "10m"
                  max-file: "3"
              deploy:
                replicas: 1
                restart_policy:
                  condition: any
                  delay: 5s
                  max_attempts: 3
                  window: 120s
                update_config:
                  parallelism: 1
                  delay: 10s
                  failure_action: rollback
                  order: stop-first
                rollback_config:
                  parallelism: 1
                  delay: 5s
                  failure_action: pause
                  order: stop-first
                resources:
                  reservations:
                    cpus: '0.1'
                    memory: 128M
                  limits:
                    cpus: '0.2'
                    memory: 256M
                labels:
                  - "traefik.enable=false"
          
          networks:
            shared-network:
              external: true
          EOF
          
          echo "‚úÖ Compose file created: $COMPOSE_FILE"
          
          # Save GCP key for authentication
          echo '${{ secrets.GCP_REGISTRY_SA_KEY }}' > /tmp/gcp-key.json
          chmod 600 /tmp/gcp-key.json
          
          # Authenticate to Google Cloud Registry
          echo "üîê Authenticating to Google Cloud Registry..."
          cat /tmp/gcp-key.json | docker login -u _json_key --password-stdin $REGISTRY
          
          # Initialize Docker Swarm if not already initialized
          if ! docker info --format '{{.Swarm.LocalNodeState}}' | grep -q "active"; then
            echo "üéØ Initializing Docker Swarm..."
            docker swarm init --advertise-addr $(hostname -I | awk '{print $1}') || echo "‚ö†Ô∏è Swarm may already be initialized"
          fi
          
          # Create shared-network if it doesn't exist
          if ! docker network ls | grep -q "shared-network"; then
            echo "üîß Creating shared-network..."
            docker network create --driver overlay --attachable shared-network
          fi
          
          # Pull latest image
          echo "üì• Pulling latest Docker image..."
          docker pull $REGISTRY/$PROJECT_ID/$REPOSITORY/$IMAGE_NAME:latest
          
          # Stop existing stack if running
          if docker stack ls | grep -q "$STACK_NAME"; then
            echo "üîÑ Stopping existing stack $STACK_NAME..."
            docker stack rm "$STACK_NAME" || true
            echo "‚è≥ Waiting for services to stop..."
            sleep 15
          fi
          
          # Deploy new stack with environment variables
          echo "üöÄ Deploying new stack $STACK_NAME..."
          POSTGRES_URL="$POSTGRES_URL" \
          METRICS_ENABLED="${{ vars.METRICS_ENABLED || 'false' }}" \
          OPENTELEMETRY_ENABLED="${{ vars.OPENTELEMETRY_ENABLED || 'false' }}" \
          OPENTELEMETRY_COLLECTOR_URL="${{ vars.OPENTELEMETRY_COLLECTOR_URL || 'http://localhost:4317' }}" \
          OPENTELEMETRY_USE_TLS="${{ vars.OPENTELEMETRY_USE_TLS || 'false' }}" \
          docker stack deploy -c "$COMPOSE_FILE" "$STACK_NAME"
          
          # Wait for services to start
          echo "‚è≥ Waiting for services to start..."
          sleep 30
          
          # Check stack status
          echo "üìä Checking stack status..."
          docker stack services "$STACK_NAME"
          
          # Clean up GCP key
          rm -f /tmp/gcp-key.json
          
          echo "‚úÖ Deployment completed successfully!"

    - name: Health check
      run: |
        echo "Waiting for deployment to stabilize..."
        sleep 30
        
        if [ -n "${{ secrets.DYNDNS_URL }}" ]; then
          echo "Checking health via DynDNS: ${{ secrets.DYNDNS_URL }}"
          curl -f "http://${{ secrets.DYNDNS_URL }}:8001/health" || echo "Warning: Health check failed"
        fi

    - name: Deployment summary
      run: |
        echo "üöÄ Deployment completed!"
        echo "Image: ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/backend:latest"
        echo "Server: ${{ vars.HOME_SERVER_IP }}"
        echo "Port: 8001"
        if [ -n "${{ secrets.DYNDNS_URL }}" ]; then
          echo "Public URL: http://${{ secrets.DYNDNS_URL }}:8001"
        fi

